<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stick Fighter Mobile</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-color: #262626;
            --accent-color: #f1c40f; /* 스틱파이터 특유의 노란색 */
            --text-color: #eeeeee;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: Arial, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }

        /* 상단 바 */
        #header {
            height: 50px;
            background: var(--panel-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            border-bottom: 1px solid #333;
        }

        /* 메인 캔버스 영역 */
        #canvas-container {
            flex: 1;
            position: relative;
            background: #ffffff; /* 스틱파이터는 작업 영역이 흰색인 경우가 많음 */
            overflow: hidden;
        }

        canvas {
            display: block;
            touch-action: none; /* 브라우저 기본 터치 동작 방지 */
        }

        /* 하단 타임라인 컨트롤 */
        #controls {
            height: 80px;
            background: var(--panel-color);
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
            overflow-x: auto;
            border-top: 1px solid #333;
        }

        .btn {
            padding: 10px 15px;
            background: #444;
            border: none;
            color: white;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
        }

        .btn.primary { background: var(--accent-color); color: #000; font-weight: bold; }

        .frame-thumb {
            min-width: 50px;
            height: 50px;
            background: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 2px solid transparent;
        }
        .frame-thumb.active { border-color: var(--accent-color); }

        /* 좌우 플로팅 버튼 (모바일 편의성) */
        .side-btn {
            position: absolute;
            bottom: 100px;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
    </style>
</head>
<body>

<div id="header">
    <div style="font-weight: bold; color: var(--accent-color);">STICK FIGHTER</div>
    <div>
        <button class="btn" onclick="playAnim()">▶ Play</button>
        <button class="btn" onclick="saveData()">Save</button>
    </div>
</div>

<div id="canvas-container">
    <canvas id="mainCanvas"></canvas>
    <div class="side-btn" style="left: 20px;" onclick="undo()">⟲</div>
    <div class="side-btn" style="right: 20px;" onclick="addStickman()">+</div>
</div>

<div id="controls">
    <button class="btn primary" onclick="nextFrame()">Next Frame</button>
    <div id="timeline" style="display: flex; gap: 5px;">
        </div>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvas-container');

    let frames = [];
    let currentIdx = 0;
    let objects = [];
    let selectedJoint = null;
    let isPlaying = false;

    // --- 스틱맨 구조 정의 ---
    function createStickman(x, y) {
        return {
            type: 'stickman',
            joints: [
                { id: 'hip', x: x, y: y, p: null },
                { id: 'neck', x: x, y: y-50, p: 'hip' },
                { id: 'head', x: x, y: y-75, p: 'neck' },
                { id: 'l_arm', x: x-30, y: y-30, p: 'neck' },
                { id: 'r_arm', x: x+30, y: y-30, p: 'neck' },
                { id: 'l_leg', x: x-20, y: y+50, p: 'hip' },
                { id: 'r_leg', x: x+20, y: y+50, p: 'hip' }
            ]
        };
    }

    // --- 초기화 ---
    function init() {
        resize();
        window.addEventListener('resize', resize);
        objects.push(createStickman(canvas.width/2, canvas.height/2));
        saveToFrame();
        updateUI();
        
        // 터치 및 마우스 이벤트 통합 등록
        canvas.addEventListener('mousedown', startDrag);
        canvas.addEventListener('mousemove', drag);
        canvas.addEventListener('mouseup', endDrag);
        
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrag(e.touches[0]); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); drag(e.touches[0]); }, {passive: false});
        canvas.addEventListener('touchend', endDrag);

        render();
    }

    function resize() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        render();
    }

    // --- 드래그 로직 ---
    function startDrag(e) {
        if (isPlaying) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        objects.forEach(obj => {
            obj.joints.forEach(j => {
                if (Math.hypot(j.x - x, j.y - y) < 25) { // 모바일 대응용 넓은 히트박스
                    selectedJoint = { j, obj };
                }
            });
        });
    }

    function drag(e) {
        if (!selectedJoint) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const dx = x - selectedJoint.j.x;
        const dy = y - selectedJoint.j.y;

        if (selectedJoint.j.id === 'hip') {
            selectedJoint.obj.joints.forEach(joint => {
                joint.x += dx; joint.y += dy;
            });
        } else {
            selectedJoint.j.x = x;
            selectedJoint.j.y = y;
        }
        render();
    }

    function endDrag() {
        selectedJoint = null;
        saveToFrame();
    }

    // --- 시스템 로직 ---
    function saveToFrame() {
        frames[currentIdx] = JSON.parse(JSON.stringify(objects));
    }

    function nextFrame() {
        saveToFrame();
        currentIdx++;
        if (!frames[currentIdx]) {
            frames[currentIdx] = JSON.parse(JSON.stringify(frames[currentIdx-1]));
        }
        objects = JSON.parse(JSON.stringify(frames[currentIdx]));
        updateUI();
        render();
    }

    function updateUI() {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '';
        frames.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = `frame-thumb ${i === currentIdx ? 'active' : ''}`;
            div.innerText = i + 1;
            div.onclick = () => {
                currentIdx = i;
                objects = JSON.parse(JSON.stringify(frames[i]));
                updateUI();
                render();
            };
            timeline.appendChild(div);
        });
    }

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 양파 껍질 (이전 프레임 잔상)
        if (currentIdx > 0 && !isPlaying) {
            drawData(frames[currentIdx-1], 'rgba(0,0,0,0.1)', 'rgba(0,0,0,0.05)');
        }

        // 현재 스틱맨 그리기
        drawData(objects, 'black', '#f1c40f');
    }

    function drawData(dataList, lineColor, jointColor) {
        dataList.forEach(obj => {
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = lineColor;
            
            obj.joints.forEach(j => {
                if (j.p) {
                    const parent = obj.joints.find(p => p.id === j.p);
                    ctx.beginPath();
                    ctx.moveTo(parent.x, parent.y);
                    ctx.lineTo(j.x, j.y);
                    ctx.stroke();
                }
                
                // 관절 노드 (스틱파이터 특유의 원)
                ctx.fillStyle = jointColor;
                ctx.beginPath();
                ctx.arc(j.x, j.y, 6, 0, Math.PI*2);
                ctx.fill();
                ctx.stroke();

                if (j.id === 'head') {
                    ctx.beginPath();
                    ctx.arc(j.x, j.y - 18, 18, 0, Math.PI*2);
                    ctx.stroke();
                }
            });
        });
    }

    function playAnim() {
        if (isPlaying) return;
        isPlaying = true;
        let i = 0;
        const timer = setInterval(() => {
            objects = JSON.parse(JSON.stringify(frames[i]));
            render();
            i++;
            if (i >= frames.length) {
                clearInterval(timer);
                isPlaying = false;
                objects = JSON.parse(JSON.stringify(frames[currentIdx]));
                render();
            }
        }, 100);
    }

    function addStickman() {
        objects.push(createStickman(100, 100));
        render();
    }

    init();
</script>

</body>
</html>
